---
title: "lab_05"
author: "Sean Mussenden"
date: "8/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## About this lab

Here's the scenario: You are a reporter for West Virginia news organization in the state's second largest county (by population), and you are interested in finding a story about how PPP loans affected an important local industry. You want to get a sense of how businesses in that industry fared after getting PPP loans.  But you aren't totally sure what industry to explore.  The questions in this lab are designed to help you identify an industry to examine, identify potential trends, identify potential characters for a story, and come up with a roadmap for follow-up research and reporting. It also will help you think through problems that might affect your conclusions.  

To complete this lab, you need to:
* run existing code as directed (look for **Task**).
* modify existing code as directed (look for **Task**).
* write code in empty codeblocks provided to answer questions included (look for **Q**).
* write out the answer in the form of a complete sentence in the space given (look for **A**).

When you are finished, commit changes and push to your personal GitHub repo, then submit the URL to this document on ELMS.

## Load libraries and establish settings

You'll need to load two packages for this: the tidyverse and janitor.

**Task** load these two packages.

```{r}
# Turn off scientific notation
options(scipen=999)

# Load the tidyverse. If you have not installed the tidyverse already, remove the # from the next line and run it first.  
# install.packages('tidyverse')
library(tidyverse)
library(janitor)

```

## Load Data

You'll need to load three data sets for this:

* The West Virginia slice of the PPP loan data (lab_05.rds).
* A "lookup table" that allows you to translate NAICS (industry) numeric codes to industry titles (naics_codes.csv).
* A table of West Virginia population by county (American Community Survey, 2019 5-year averages) (wv_population_county.csv).

All three data sets are in the data folder.  Write code to load them in the codeblock below.

**Task** Read the files in and assign them to appropriate variable names.

```{r}
# Load the WV PPP loan data table
west_virginia_ppp <- read_rds('data/lab_05.rds')

# Load the NAICS lookup table
naics_codes <- read_csv('data/naics_codes.csv')

# Load the West Virginia population by county table
wv_population_county <- read_csv("data/wv_population_county.csv")

```

## Answer questions

Q1. In the data folder, there is a csv called zip_25401_loan_sample.csv.  It contains a sample of loans from West Virginia ZIP Code 25401. As we read earlier this semester, a lot of loan applications coming from the same street address could indicate fraud. 

You are going to examine this data to see if we can find a lot of loans coming from the same address.  Here's the problem: the street address field is pretty messy.  The same address appears with minor variations --  "1003 Sushruta Dr" vs "1003 SUSHRUTA DR" -- that will prevent proper grouping. 

First, upload the data into Open Refine and standardize/clean the address field. If you've done it properly, you should have 65 discrete addresses. 

Then export the data, load it in the codeblock below. Answer these questions:
* What is the street address that has the most loans?
* How many loans are there at that street address?
* What are the names of the businesses at that address?
* Google the business names and the address. Be sure to find the website of the company that appears twice. Search the company names on https://opencorporates.com. Does it seem like multiple loan applications by different companies coming from this address seem suspicious? Why or why not?  

https://opencorporates.com/companies/us_wv/370554

```{r}
berkeley_ppp_zip_count <- west_virginia_ppp %>%
  filter(project_county_name == "BERKELEY") %>%
  mutate(zip5=str_sub(zip,start=1L, end=5L)) %>%
  group_by(zip5) %>%
  count() 

berkeley_25401_ppp <- west_virginia_ppp %>%
  filter(project_county_name == "BERKELEY") %>%
  mutate(zip5=str_sub(zip,start=1L, end=5L)) %>%
  filter(zip5=="25401") %>%
  mutate(address_clean = str_to_title(address))

berkeley_25401_multiple <- berkeley_25401_ppp %>%
  group_by(address_clean) %>%
  count() %>%
  arrange(desc(n)) %>%
  filter(n>1) %>%
  select(address_clean) %>%
  distinct()

berkeley_25401_ppp <- berkeley_25401_ppp %>%
  inner_join(berkeley_25401_multiple) %>%
  select(-address_clean)
  
  
  

write_csv(berkeley_25401_ppp,"sample2.csv")

```


Q1. Start with the subset of PPP loans in West Virginia's second largest county. And then answer the following questions:

* Which city in that county had the highest number of loans? 
* In the city that answered the last question, which industry title had more loans than any other industry title? 

Requirement: you MUST export a dataframe of PPP loans from R Studio at some point in the process (not necessarily at the beginning!), load it into Open Refine, clean the city column, export it from Open Refine, and reimport into R Studio. To export data, you will use the write_csv() function.

Guidance: there are a lot of steps you'll need to take to answer this question. You may or may not find it helpful to write out in English what you plan to do step-by-step before you start writing code.   

A1. Martinsburg, the biggest city in Berekley County, West Virginia, had more loans than any other city in that county.  The "full-service restaurants" industry had more approved loans than any other industry, just ahead of real estate agents and child care providers. 
```{r}

# There are two approaches to answering this question here.  Approach A makes heavy use of the familiar filter() function. Approach B makes heavy use of a new-to-you type of join, inner_join(), to do a "filtering join".

###############
#### Approach A (Less Advanced): Relying on filter()
###############

#####
### Step 1: Identify West Virginia's second largest county
#####

## Sort population table
wv_population_county_sorted <- wv_population_county %>%
  arrange(desc(population_2019))

## Display it.  Berkeley County is #2 with 115K people.
wv_population_county_sorted

#####
### Step 2: Create a table of Berkeley County loans
#####

berkeley_ppp <- west_virginia_ppp %>%
  filter(project_county_name == "BERKELEY")

#####
### Step 3: Identify city in Berkeley County that got the most loans.
#####

## Group by city and county
berkeley_top_city <- berkeley_ppp %>%
  group_by(city) %>%
  summarise(
    count=n()
  ) %>%
  arrange(desc(count))

## Display to notice city field needs cleaning in order to group properly. 
berkeley_top_city

#####
### Step 4: Export data to Open Refine, clean city field and reimport to R Studio. 
#####

## Export Berkeley loan data to Open Refine
write_csv(berkeley_ppp,"data/berkeley_ppp.csv")

## Open Refine Cleaning Steps
# Launch Open Refine
# Choose file berkeley_ppp.csv
# Hit next to upload data
# Click create project
# Make copy of city column called city_clean.  Click dropdown arrow next to city > edit column > add column based on this column. When window pops up, type city_clean in "New column name" field and click OK button.
# Click dropdown arrow next to city_clean > Facet > Text facet
# On left sidebar click "cluster"
# Use various cleaning functions until city inconsistency grouping problems are resolved.
# Click "export" > comma separated value > 
# Move to proper folder with the rest of your data in the GitHub repo.
# Change the name to something like berkeley_ppp_open_refine.csv

## Reimport cleaned Open Refine data, do some further cleaning if desired to fix capitalization.

berkeley_ppp <- read_csv("data/berkeley_ppp_open_refine.csv") %>%
  mutate(city_clean = str_to_title(city_clean))

#####
### Step 5: Identify top city in Berkeley County.
#####

## Group by cleaned city column and count loans, sort descending
berkeley_ppp_cities <- berkeley_ppp %>%
  group_by(city_clean) %>%
  summarise(
    count=n()
  ) %>%
  arrange(desc(count))

## Display it. Martinsburg with 1166 approved loans.
wv_population_county_sorted

#####
### Step 6: Create a Martinsburg only PPP loans table
#####

martinsburg_ppp <- berkeley_ppp %>%
  filter(city_clean == "Martinsburg")

#####
### Step 7: Examine top industries in Martinsburg
#####

# Join to naics lookup table, group by industry title, count sort descending
martinsburg_ppp_industries <- martinsburg_ppp %>%
  left_join(naics_codes) %>%
  group_by(title) %>%
  summarise(
    count=n()
  ) %>%
  arrange(desc(count))

# Display it. 
martinsburg_ppp_industries

###############
#### Approach B (More advanced): Relying on inner_join() to do "filtering joins"
###############

#####
### Step 1: Identify West Virginia's second largest county
#####

## Sort population table, keep the second row using slice, keep only the county column, convert county to uppercase to match ppp data for join
wv_second_county <- wv_population_county %>%
  arrange(desc(population_2019)) %>%
  slice(2) %>%
  select(county) %>%
  mutate(county = str_to_upper(county))

## Display it.  Berkeley County is #2 with 115K people.
wv_population_county_sorted

#####
### Step 2: Create a table of Berkeley County loans
#####

berkeley_ppp <- west_virginia_ppp %>%
  inner_join(wv_second_county,by=c("project_county_name" = "county"))

#####
### Step 3: Identify city in Berkeley County that got the most loans.
#####

## Group by city and county
berkeley_top_city <- berkeley_ppp %>%
  group_by(city) %>%
  summarise(
    count=n()
  ) %>%
  arrange(desc(count))

## Display to notice city field needs cleaning in order to group properly. 
berkeley_top_city

#####
### Step 4: Export data to Open Refine, clean city field and reimport to R Studio. 
#####

## Export Berkeley loan data to Open Refine
write_csv(berkeley_ppp,"data/berkeley_ppp.csv")

## Open Refine Cleaning Steps
# Launch Open Refine
# Choose file berkeley_ppp.csv
# Hit next to upload data
# Click create project
# Make copy of city column called city_clean.  Click dropdown arrow next to city > edit column > add column based on this column. When window pops up, type city_clean in "New column name" field and click OK button.
# Click dropdown arrow next to city_clean > Facet > Text facet
# On left sidebar click "cluster"
# Use various cleaning functions until city inconsistency grouping problems are resolved.
# Click "export" > comma separated value > 
# Move to proper folder with the rest of your data in the GitHub repo.
# Change the name to something like berkeley_ppp_open_refine.csv

## Reimport cleaned Open Refine data, do some further cleaning if desired to fix capitalization.

berkeley_ppp <- read_csv("data/berkeley_ppp_open_refine.csv") %>%
  mutate(city_clean = str_to_title(city_clean))

#####
### Step 5: Identify top city in Berkeley County.
#####

## Group by cleaned city column and count loans, sort descending
berkeley_top_city <- berkeley_ppp %>%
  group_by(city_clean) %>%
  summarise(
    count=n()
  ) %>%
  arrange(desc(count)) %>%
  slice(1) %>%
  select(city_clean) 

## Display it. Martinsburg with 1166 approved loans.
berkeley_top_city

#####
### Step 6: Create a Martinsburg only PPP loans table
#####

martinsburg_ppp <- berkeley_ppp %>%
  inner_join(berkeley_top_city)

#####
### Step 7: Examine top industries in Martinsburg
#####

# Join to naics lookup table, group by industry title, count sort descending
martinsburg_ppp_industries <- martinsburg_ppp %>%
  left_join(naics_codes) %>%
  group_by(title) %>%
  summarise(
    count=n()
  ) %>%
  arrange(desc(count))

# Display it. 
martinsburg_ppp_industries
```

Q2. What are your two best hypotheses, which you'd need to confirm with reporting and further analysis, that explain why that industry is at the top of the list?
A2. Here are four, though you may think of others.   

* Full-service restaurants may just be more common than other types of businesses in Martinsburg. If businesses in all industries were equally likely to apply for a loan -- which may not be a safe assumption to make! -- then it would make sense that more restaurants equals more loans.
* Restaurants may have been more likely than businesses in other industries to apply for multiple loans with different lenders, leading to multiple records in the PPP data. For example, SISSY'S FAMILY RESTAURANT LLC, MOTHER SHUCKERS CRAB SHACK, LAS TRANCAS OF MARTINSBURG INC. and several others have two loans of differing amounts on different dates at the same address. Is this true of other big industries?
* Sit-down restaurants were particularly vulnerable during the pandemic, especially the early months, as public health measures in many states limited or prevent in-restaurant dining. The economic hit may have driven restaurant owners to seek help with more urgency than in other industries. 
* The position of restaurants at the top may just be an artifact of using fine-grained NAICS data (see below).

Q3. In response to the previous question, you identified the industry that had more loans than any other industry in the city with the most loans in West Virginia's second largest county. Examine the final table you produced. Are there any potential issues that could affect the accuracy or validity of your answer?
Q3. Two issues come to mind, but there may be others. 

First, there are 14 NA values. The NA values are there because of an issue that arose on joining the Martinsburg PPP table to the NAICS lookup table. In the Martinsburg PPP table, seven loans had a NA value for NAICS code. Seven others had a 999990 value, and one had 333298.  Neither of those values exist in the NAICS lookup table. That's enough missing values that it might affect our ability to draw conclusions.

Second, the NAICS industry code categories we're using here are very fine-grained.  If our question is which is the largest industry in town, do we need to do some additional refining to lump like industries together? For example, these are all separate categories related to shipping:

* General Freight Trucking, Long-Distance, Less Than Truckload
* Freight Transportation Arrangement
* Specialized Freight (except Used Goods) Trucking, Long-Distance
* General Freight Trucking, Local
* Specialized Freight (except Used Goods) Trucking, Local
* General Freight Trucking, Long-Distance, Truckload

NAICS codes have a special format. The digits are ordered from the broadest category on the left to the narrowest sub category on the right. Two-digit codes are the broadest, six-digit codes are the most specific. Here's an example:

* 72	Accommodation and Food Services	
* 7225	Restaurants and Other Eating Places
* 722511	Full-Service Restaurants	369,862
* 722513	Limited-Service Restaurants	285,678
* 722514	Cafeterias, Grill Buffets, and Buffets	
* 722515	Snack and Nonalcoholic Beverage Bars	

If we wanted to get a broader picture, we could use str_sub() to create a new column that keeps only the first four digits of the NAICS code data, and join it with a NAICS lookup table that contained these higher level categories. 

Q4. Start with a table of loans to all businesses in the city and industry that answered question 1. Answer the following questions:
* What is the name of the business that got the highest approved loan amount? 
* How much was it for?
* When was it approved?
* How many jobs does the data say were retained?
* Is there a difference between the business' name in the PPP data and the name its customers know it by? If so, what is that name?
* How many locations does this business have? 
* Did one of its locations close during the pandemic, either before or after it got the loan?

Hint: you will not find the answers to the last three questions in the data.  You could call them directly to get that information, but I don't want you to do that for this assignment.  Instead, do some web research. I would start by Googling the company name from the data and looking at the page that comes up for the business from at http://apps.sos.wv.gov/. I would use information I found on that page and use Google, the [Wayback machine](https://archive.org/web/) (which lets you look at older versions of a company's website), Yelp, and Facebook. 

A4. "COTTLE CHRISTI L LLC" got the highest approved loan amount, $280,434. The loan was approved on Feb. 17, 2021, nearly a full year after the pandemic started. 

The data says it allowed the company to retain 94 jobs, more than any other full service restaurant in town. 

Based on web research, "COTTLE CHRISTI L LLC" appears to be the corporate holding company for a small chain of restaurants, according to its page on the [West Virginia Secretary of State Corporate Lookup] ](http://apps.sos.wv.gov/business/corporations/organization.aspx?org=338507). 

According to the corporate page, the business has several "DBA" or "Doing Business As" names, including several variations of Kitzie's (Kitzie's Cafe, Kitzie's Cafe II, Kitzie's of Inwood, Kitzie's of Spring Mills, Kitzie's Restaurant & Lounge) and Riverbend Bar & Grill. The "termination date" for one of the DBA names, "Kitzie's of Inwood" suggests it may have closed after the pandemic started, in May 2020. 

A Google search for A Google search for "kitzie's wv" gets us to the website for [Kitzie's Restaurant & Lounge](http://www.kitziesrestaurant.com/").  It shows two locations in Martinsburg ("Spring Mills" and "Martinsburg").  Using the "Wayback Machine" at Archive.org, we can see how the restaurant's website changed over time.  This is how it [looked in January 2019](https://web.archive.org/web/20190115061057/http://www.kitziesrestaurant.com/), showing a third location in Inwood, WV.  By [June 2019](https://web.archive.org/web/20190618194756/http://www.kitziesrestaurant.com/) though, the Inwood location no longer appeared. Yelp users also [reported the Inwood location appears to be closed](https://www.yelp.com/biz/kitzies-inwood-inwood), with the last review left in March 2019. We'd have to call to confirm, but it appears the location closed before the pandemic started.  

```{r}

martinsburg_ppp_restaurants <- martinsburg_ppp %>%
  left_join(naics_codes) %>%
  filter(str_detect(title,"Full-Service Restaurants")) %>%
  arrange(desc(amount))

martinsburg_ppp_restaurants
```
Q5. Pick out five businesses on the list created in the table that you used to answer the question above.  How many of these businesses you selected have locations that closed down during the pandemic? Do some quick web research. If the trends you saw in these five held true across all 50 businesses on this list, what might you hypothesize about businesses in this industry that got PPP loans in this city?  Write up a paragraph that could serve as the foundation for further reporting. 
A5. 


-30-
